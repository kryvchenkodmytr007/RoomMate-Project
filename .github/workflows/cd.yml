name: CD

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy (Render deploy hooks)
    runs-on: ubuntu-latest

    steps:
      - name: Check deploy hooks
        run: |
          missing=0
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_PROFILES }}" ]; then
            echo "::warning::RENDER_DEPLOY_HOOK_PROFILES is not set"
            missing=1
          fi
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_MATCHES }}" ]; then
            echo "::warning::RENDER_DEPLOY_HOOK_MATCHES is not set"
            missing=1
          fi

          if [ "$missing" -eq 1 ]; then
            echo "Deploy hooks are missing â†’ skipping deploy."
            exit 0
          fi

      - name: Deploy profiles-service
        if: ${{ secrets.RENDER_DEPLOY_HOOK_PROFILES }}
        run: curl -fsSL -X POST "${{ secrets.RENDER_DEPLOY_HOOK_PROFILES }}"

      - name: Deploy matches-service
        if: ${{ secrets.RENDER_DEPLOY_HOOK_MATCHES }}
        run: curl -fsSL -X POST "${{ secrets.RENDER_DEPLOY_HOOK_MATCHES }}"
